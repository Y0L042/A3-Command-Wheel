# Command Wheel Execution Flow

## Complete Call Chain

### Main Command Execution (e.g., Section 0 - "Hold")

```
User clicks on wheel section 0
         ‚Üì
fn_load.sqf (MouseButtonUp handler)
         ‚Üì
CMDWHEEL_fnc_wheelClick called with: _selected = 0
         ‚Üì
fn_wheelClick.sqf (determines it's a main command)
         ‚Üì
[0] call CMDWHEEL_fnc_executeAction
         ‚Üì
fn_executeAction.sqf
         ‚Üì
player call CMDWHEEL_fnc_00  ‚Üê player passed as _this/_caller
         ‚Üì
fn_00.sqf (wrapper)
  params ["_caller"];  ‚Üê _caller = player
         ‚Üì
_caller call CMDWHEEL_fnc_hold
         ‚Üì
fn_hold.sqf (implementation)
  params ["_caller"];  ‚Üê _caller = player
         ‚Üì
// Your command logic executes here
systemChat format ["Command fn_hold.sqf called by %1", name _caller];
```

### Subcommand Execution (e.g., Section 0, Sub 1 - "Move there")

```
User holds click on wheel section 0, moves to sub 1
         ‚Üì
fn_load.sqf (MouseButtonUp handler after hold)
         ‚Üì
CMDWHEEL_fnc_wheelClick called with: [0, 1]
         ‚Üì
fn_wheelClick.sqf (determines it's a subcommand)
         ‚Üì
player call CMDWHEEL_fnc_00_1  ‚Üê player passed as _this/_caller
         ‚Üì
fn_00_1.sqf (wrapper)
  params ["_caller"];  ‚Üê _caller = player
         ‚Üì
_caller call CMDWHEEL_fnc_moveThere
         ‚Üì
fn_moveThere.sqf (implementation)
  params ["_caller"];  ‚Üê _caller = player
         ‚Üì
// Your command logic executes here
systemChat format ["Command fn_moveThere.sqf called by %1", name _caller];
```

## Key Files and Their Roles

### 1. `init.sqf`
**Role:** Initialization
- Adds action to player to open command wheel (User20 key)
- Creates the dialog when action is triggered

### 2. `fn_load.sqf`
**Role:** Event Handler Setup
- Sets up mouse button event handlers
- Implements hold time detection (0.4 second threshold)
- Calls `CMDWHEEL_fnc_wheelClick` when user releases mouse

### 3. `fn_wheelClick.sqf`
**Role:** Command Router
- Determines if click is main command or subcommand
- Routes to appropriate function
- **NOW PASSES `player` as caller parameter**

### 4. `fn_executeAction.sqf`
**Role:** Main Command Dispatcher
- Handles main section commands (0-7)
- Checks for custom CBA settings
- Calls wrapper functions (fn_00, fn_01, etc.)
- **NOW PASSES `player` as caller parameter**

### 5. Wrapper Functions (`fn_00.sqf`, `fn_00_1.sqf`, etc.)
**Role:** Command Wrappers
- Generated by `generate_commands.py`
- Accept `_caller` parameter (the player)
- Display hint text
- Call actual implementation functions

### 6. Implementation Functions (`fn_hold.sqf`, `fn_moveThere.sqf`, etc.)
**Role:** Actual Command Logic
- Contains the real command implementation
- Receives `_caller` parameter
- This is where you write your command behavior

## Parameter Flow

All functions in the chain receive `player` as the caller:

```sqf
// In fn_executeAction.sqf and fn_wheelClick.sqf
player call CMDWHEEL_fnc_XX;  // player becomes _this/_caller

// In wrapper functions (fn_00.sqf, etc.)
params ["_caller"];  // _caller = player

// In implementation functions (fn_hold.sqf, etc.)
params ["_caller"];  // _caller = player
```

## Testing the Chain

To verify commands execute correctly, check for these messages:

### Quick Click (Main Command):
1. "Executing action..." (from fn_executeAction.sqf)
2. Hint "Hold" (from fn_00.sqf)
3. "Command fn_hold.sqf called by PlayerName" (from fn_hold.sqf)

### Hold Click (Subcommand):
1. "Executing subcommand: Section 0, Sub 1" (from fn_wheelClick.sqf)
2. Hint "Move there" (from fn_00_1.sqf)
3. "Command fn_moveThere.sqf called by PlayerName" (from fn_moveThere.sqf)

## What Was Fixed

### Before:
```sqf
// fn_executeAction.sqf
call (_defaultFunctions select _actionIndex);  ‚ùå No caller passed

// fn_wheelClick.sqf
call _func;  ‚ùå No caller passed

// Result: _caller was undefined in wrapper functions
```

### After:
```sqf
// fn_executeAction.sqf
player call (_defaultFunctions select _actionIndex);  ‚úÖ player passed as caller

// fn_wheelClick.sqf
player call _func;  ‚úÖ player passed as caller

// Result: _caller = player in all wrapper and implementation functions
```

## Custom CBA Settings Override

The system also supports custom code via CBA settings:

```
User clicks section 0
         ‚Üì
fn_executeAction.sqf checks CMDWHEEL_action0_enabled
         ‚Üì
If enabled AND CMDWHEEL_action0_code is not empty:
    ‚Üí Execute custom code directly (bypasses all wrappers)
         ‚Üì
Otherwise:
    ‚Üí Follow normal execution chain
```

## Summary

‚úÖ **init.sqf** - Opens the wheel dialog
‚úÖ **fn_load.sqf** - Handles user input and timing
‚úÖ **fn_wheelClick.sqf** - Routes to correct command (NOW passes player)
‚úÖ **fn_executeAction.sqf** - Dispatches main commands (NOW passes player)
‚úÖ **Wrapper functions** - Receive player as _caller
‚úÖ **Implementation functions** - Receive player as _caller

All commands now execute correctly with proper parameter passing! üéâ
